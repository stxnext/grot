(function(){window.cfg={defaultBoardSize:4,baseScale:1,baseWindowSize:{width:1600,height:900},customBoardSize:!0,circleColor1:"#868788",circleColor2:"#ffec00",circleColor3:"#8d198f",circleColor4:"#00968f",circleRadius:46,spaceBetweenFields:12,arrowColor:"#ffffff",tweenDuration:.5,fontScoMovColor:"#868788",fontScoMovNumColor:"#00968f",fontMenuColor:"#ffffff",fontFamily:"Lato",fontScoMovSize:46,fontRestSize:38,fontStyle:"Bold",bodyColor:"#ffffff",overlayColor:"#333333",overlayBodyColor:"#484848",scoreBoardLink:"http://stxnext.pl/",helpDesc:" This logic game is about making the most\n valuable chains possible!\n\n Tap or click any field to start a chain\n reaction - fields will move one by one in\n the direction shown by the arrowheads.\n\n Longer chains grant move bonuses.\n Clear all fields in a row or in a column\n to get extra points.\n\n Collect as many points as possible!",aboutDesc:" Created by STX Next\n http://stxnext.com\n \n\n\n\n\n\n\n\n Source code\n https://github.com/stxnext/grot\n \n Credits\n Wojciech Lichota\n Michal Janiszewski\n Damian Polcyn",aboutVer:" v1.1",stxnextLink:"http://stxnext.com/"}}).call(this),function(){var a,b={}.hasOwnProperty,c=function(a,c){function d(){this.constructor=a}for(var e in c)b.call(c,e)&&(a[e]=c[e]);return d.prototype=c.prototype,a.prototype=new d,a.__super__=c.prototype,a};a=function(){function a(){var a,b;b=this,a=window.cfg,this.Widget=function(a){function b(a){var c;for(c in a)"undefined"!=typeof this[c]&&"function"!=typeof this[c]&&(this[c]=a[c]);a.margins||(this.margins={x:0,y:0}),b.__super__.constructor.apply(this,arguments),this.on("update",this.updateHandler)}return c(b,a),b.prototype.margins=null,b.prototype.currentScale=null,b.prototype.layer=null,b.prototype.getCurrentX=function(){return this.margins.x*this.currentScale},b.prototype.getCurrentY=function(){return this.margins.y*this.currentScale},b.prototype.rePosition=function(){return this.x(this.getCurrentX()),this.y(this.getCurrentY()),[this.x(),this.y()]},b.prototype.updateHandler=function(){return this.layer?(this.currentScale=this.layer.currentScale,this.rePosition()):void 0},b.prototype.scale=function(a){return null!=this.group?this.group.scale({x:a,y:a}):(a={x:a,y:a},b.__super__.scale.apply(this,arguments))},b.prototype.centerElement=function(a){return a.offsetX(a.width()/2),a.offsetY(a.height()/2)},b}(Kinetic.Group),this.Layer=function(a){function b(a){var c;for(c in a)"undefined"!=typeof this[c]&&"function"!=typeof this[c]&&(this[c]=a[c]);b.__super__.constructor.apply(this,arguments),a.margins||(this.margins={x:0,y:0})}return c(b,a),b.prototype.renderManager=null,b.prototype.currentScale=null,b.prototype.margins=null,b.prototype.updateHandler=function(){var a,b;return this.currentScale=this.renderManager.currentScale,this.scale({x:this.currentScale,y:this.currentScale}),this.rePosition(),b=(this.getWidth()*this.currentScale||this.parent.getWidth())+this.getCurrentX(),a=(this.getHeight()*this.currentScale||this.parent.getHeight())+this.getCurrentY(),this.canvas.setSize(b,a),this.batchDraw()},b.prototype.getCurrentX=function(){var a;return"number"==typeof this.margins.x?this.margins.x*this.currentScale:(a=(this.margins.x.match(/\d+/)||[0])[0]/100,(this.parent.getWidth()-this.getWidth()*this.currentScale)*a)},b.prototype.getCurrentY=function(){var a;return"number"==typeof this.margins.y?this.margins.y*this.currentScale:(a=(this.margins.x.match(/\d+/)||[0])[0]/100,(this.parent.getHeight()-this.getHeight()*this.currentScale)*a)},b.prototype.rePosition=function(){return this.x(this.getCurrentX()),this.y(this.getCurrentY()),[this.x(),this.y()]},b}(Kinetic.Layer),this.RenderManager=function(){function b(){var a,b,c,d,e,f,g;for(null==this.baseWindowSize&&(g=this.getWindowSize(),d=g[0],a=g[1],this.baseWindowSize={width:d,height:a}),null==this.currentScale&&(this.currentScale=this.calculateScaleUnit()),c=this.stage.getLayers(),e=0,f=c.length;f>e;e++)b=c[e],b.on("update",b.updateHandler),b.fire("update");this.updateMargin()}return b.prototype.cfg=a,b.prototype.baseScale=null!=a.baseScale?a.baseScale:1,b.prototype.baseWindowSize=null!=a.baseWindowSize?a.baseWindowSize:null,b.prototype.currentScale=null,b.prototype.stage=null,b.prototype.getWindowSize=function(){return[window.innerWidth,window.innerHeight]},b.prototype.calculateScaleUnit=function(){var a,b,c,d,e,f;return f=this.getWindowSize(),d=f[0],b=f[1],a=600/900,e=d/b,c=e>a?b/a/this.baseWindowSize.width*1.2:d/a/this.baseWindowSize.height,Number(c.toFixed(2))},b.prototype.updateMargin=function(){var a,b,c,d,e,f;for(d=0,b=this.stage.getLayers(),e=0,f=b.length;f>e;e++)a=b[e],d=Math.max(d,a.canvas.width/a.canvas.getPixelRatio());return c=Math.ceil((this.getWindowSize()[0]-d)/2),c=Math.max(c,0),this.stage.getContainer().style.marginLeft=c+"px"},b.prototype.centerLayer=function(a){return a.offsetX(-(this.stage.getWidth()-a.getWidth())/2)},b.prototype.adaptStage=function(){var a,b,c;return c=this.getWindowSize(),b=c[0],a=c[1],this.stage.setHeight(a),this.stage.setWidth(b)},b.prototype.update=function(){var a,b,c,d;for(this.currentScale=this.calculateScaleUnit(),this.adaptStage(),b=this.stage.getLayers(),c=0,d=b.length;d>c;c++)a=b[c],a.fire("update");return this.stage.fire("onStageUpdated"),this.updateMargin()},b}(),this.Game=function(){function a(){window.onresize=this.update.bind(this),window.ondeviceorientation&&(window.ondeviceorientation=this.update.bind(this))}return a.prototype.update=function(){return this.renderManager.update.call(this.renderManager)},a}()}return a}(),window.GrotEngine=new a,window.Grot={}}.call(this),function(){var a,b=function(a,b){return function(){return a.apply(b,arguments)}},c={}.hasOwnProperty,d=function(a,b){function d(){this.constructor=a}for(var e in b)c.call(b,e)&&(a[e]=b[e]);return d.prototype=b.prototype,a.prototype=new d,a.__super__=b.prototype,a};a=cfg.tweenDuration,Grot.TopBarWidget=function(c){function e(){this.delayAnim=b(this.delayAnim,this);var a;e.__super__.constructor.apply(this,arguments),this.background=new Kinetic.Rect({width:600,height:210,fill:cfg.bodyColor}),this.add(this.background),this.scoreLabel=new Kinetic.Text({x:155,y:50,text:"Score",align:"center",fontSize:cfg.fontRestSize,fontFamily:cfg.fontFamily,fontStyle:cfg.fontStyle,fill:cfg.fontScoMovColor}),this.score=new Kinetic.Text({x:150,y:100,text:this.game.score,align:"center",fontSize:cfg.fontScoMovSize,fontFamily:cfg.fontFamily,fontStyle:cfg.fontStyle,fill:cfg.fontScoMovNumColor}),this.scoreDiff=new Kinetic.Text({x:150,y:150,text:"",align:"center",fontSize:cfg.fontRestSize,fontFamily:cfg.fontFamily,fill:cfg.fontScoMovNumColor}),this.movesLabel=new Kinetic.Text({x:455,y:50,text:"Moves",align:"center",fontSize:cfg.fontRestSize,fontFamily:cfg.fontFamily,fontStyle:cfg.fontStyle,fill:cfg.fontScoMovColor}),this.moves=new Kinetic.Text({x:450,y:100,text:this.game.moves,align:"center",fontSize:cfg.fontScoMovSize,fontFamily:cfg.fontFamily,fontStyle:cfg.fontStyle,fill:cfg.fontScoMovNumColor}),this.movesDiff=new Kinetic.Text({x:450,y:150,text:"",align:"center",fontSize:cfg.fontRestSize,fontFamily:cfg.fontFamily,fill:cfg.fontScoMovNumColor}),a=new Kinetic.Rect({x:0,y:200,width:600,height:2,fill:cfg.fontScoMovNumColor}),this.centerElement(this.scoreLabel),this.centerElement(this.score),this.centerElement(this.scoreDiff),this.centerElement(this.movesLabel),this.centerElement(this.moves),this.centerElement(this.movesDiff),this.add(this.scoreLabel),this.add(this.score),this.add(this.scoreDiff),this.add(this.movesLabel),this.add(this.moves),this.add(this.movesDiff),this.add(a)}return d(e,c),e.prototype.game=null,e.prototype.scoreLabel=null,e.prototype.score=null,e.prototype.movesLabel=null,e.prototype.moves=null,e.prototype.delayAnim=function(b){return delay1s(function(){return function(){var c;return c=new Kinetic.Tween({node:b,opacity:0,duration:a,onFinish:function(){return this.destroy()}}),c.play()}}(this))},e.prototype.update=function(){return this.score.setText(this.game.score),0===this.game.scoreDiff?this.scoreDiff.setText(" "):(this.scoreDiff.setText("+"+this.game.scoreDiff),this.scoreDiff.opacity(1),this.delayAnim(this.scoreDiff)),this.moves.setText(this.game.moves),0===this.game.movesDiff?this.movesDiff.setText(" "):(this.movesDiff.setText("+"+this.game.movesDiff),this.movesDiff.opacity(1),this.delayAnim(this.movesDiff)),this.centerElement(this.score),this.centerElement(this.scoreDiff),this.centerElement(this.moves),this.centerElement(this.movesDiff),this.getLayer().draw()},e}(GrotEngine.Widget),Grot.BottomBarWidget=function(a){function b(){var a,c;b.__super__.constructor.apply(this,arguments),this.background=new Kinetic.Rect({width:600,height:220,x:0,y:760,fill:cfg.bodyColor}),this.add(this.background),this.buttonHelpGroup=new Kinetic.Group({x:525,y:800}),this.circleHelp=new Kinetic.Circle({x:20,y:30,radius:40,fill:cfg.circleColor4}),this.buttonHelpGroup.add(this.circleHelp),c=new Image,c.onload=function(a){return function(){return a.imageQuestionMarkHelpLink=new Kinetic.Image({x:2,y:6,image:c,width:40,height:56}),a.buttonHelpGroup.add(a.imageQuestionMarkHelpLink),a.add(a.buttonHelpGroup)}}(this),c.src="img/question-mark-icon.png",this.buttonHelpGroup.on("mousedown touchstart",function(){return function(){return game.renderManager.menuOverlay.fire("showHelp")}}(this)),a=new Image,a.onload=function(b){return function(){return b.hero=new Kinetic.Image({x:210,y:746,image:a,width:180,height:150}),b.add(b.hero),b.getLayer().draw()}}(this),a.src="img/hero.png",this.buttonMenuGroup=new Kinetic.Group({x:45,y:800}),this.circleMenu=new Kinetic.Circle({x:20,y:30,radius:40,fill:cfg.circleColor4}),this.rectMenu1=new Kinetic.Rect({x:5,y:10,width:10,height:40,fill:cfg.fontMenuColor}),this.rectMenu2=this.rectMenu1.clone({x:25}),this.buttonMenuGroup.add(this.circleMenu),this.buttonMenuGroup.add(this.rectMenu1),this.buttonMenuGroup.add(this.rectMenu2),this.add(this.buttonMenuGroup),this.buttonMenuGroup.on("mousedown touchstart",function(){return function(){return game.renderManager.menuOverlay.fire("showMenu")}}(this))}return d(b,a),b.prototype.label=null,b.prototype.game=null,b.prototype.help=null,b.prototype.menu=null,b.prototype.centerText=function(a){return a.offsetX(a.width()/2),a.offsetY(a.height()/2)},b.prototype.scale=function(a){return this.scale({x:a,y:a})},b}(GrotEngine.Widget)}.call(this);var arrowCommands=[{y:-12.40625,x:-3.38671875,type:"M"},{y1:-8.94921875,x:-9.71484375,x1:-6.521484375,type:"Q",y:-5.4921875},{y1:-2.03515625,x:-16.365234375,x1:-12.908203125,type:"Q",y:1.392578125},{y1:1.626953125,x:-16.8779296875,x1:-16.599609375,type:"Q",y:1.7294921875},{y1:1.83203125,x:-17.5517578125,x1:-17.15625,type:"Q",y:1.685546875},{y1:1.5390625,x:-18.50390625,x1:-17.947265625,type:"Q",y:1.1142578125},{y1:.689453125,x:-19.880859375,x1:-19.060546875,type:"Q",y:-.130859375},{y1:-.921875,x:-21.0380859375,x1:-20.642578125,type:"Q",y:-1.44921875},{y1:-1.9765625,x:-21.55078125,x1:-21.43359375,type:"Q",y:-2.3427734375},{y1:-2.708984375,x:-21.580078125,x1:-21.66796875,type:"Q",y:-2.97265625},{y1:-3.236328125,x:-21.2578125,x1:-21.4921875,type:"Q",y:-3.470703125},{y:-22.748046875,x:-1.98046875,type:"L"},{y1:-23.1875,x:-1.04296875,x1:-1.541015625,type:"Q",y:-23.48046875},{y1:-23.7734375,x:.158203125,x1:-.544921875,type:"Q",y:-23.7734375},{y1:-23.7734375,x:1.30078125,x1:.802734375,type:"Q",y:-23.509765625},{y1:-23.24609375,x:2.296875,x1:1.798828125,type:"Q",y:-22.748046875},{y:-3.470703125,x:21.57421875,type:"L"},{y1:-3.236328125,x:21.8818359375,x1:21.779296875,type:"Q",y:-2.97265625},{y1:-2.708984375,x:21.8671875,x1:21.984375,type:"Q",y:-2.3427734375},{y1:-1.9765625,x:21.3544921875,x1:21.75,type:"Q",y:-1.44921875},{y1:-.921875,x:20.197265625,x1:20.958984375,type:"Q",y:-.130859375},{y1:.689453125,x:18.8203125,x1:19.376953125,type:"Q",y:1.1142578125},{y1:1.5390625,x:17.8681640625,x1:18.263671875,type:"Q",y:1.685546875},{y1:1.83203125,x:17.1943359375,x1:17.47265625,type:"Q",y:1.7294921875},{y1:1.626953125,x:16.681640625,x1:16.916015625,type:"Q",y:1.392578125},{y1:-2.03515625,x:10.03125,x1:13.224609375,type:"Q",y:-5.4921875},{y1:-8.94921875,x:3.703125,x1:6.837890625,type:"Q",y:-12.40625},{y:24.771484375,x:3.703125,type:"L"},{y1:25.005859375,x:3.52734375,x1:3.703125,type:"Q",y:25.2109375},{y1:25.416015625,x:2.9560546875,x1:3.3515625,type:"Q",y:25.5625},{y1:25.708984375,x:1.8720703125,x1:2.560546875,type:"Q",y:25.796875},{y1:25.884765625,x:.158203125,x1:1.18359375,type:"Q",y:25.884765625},{y1:25.884765625,x:-1.5556640625,x1:-.8671875,type:"Q",y:25.796875},{y1:25.708984375,x:-2.6396484375,x1:-2.244140625,type:"Q",y:25.5625},{y1:25.416015625,x:-3.2109375,x1:-3.03515625,type:"Q",y:25.2109375},{y1:25.005859375,x:-3.38671875,x1:-3.38671875,type:"Q",y:24.771484375},{y:-12.40625,x:-3.38671875,type:"L"},{type:"Z"}],arrow=new Kinetic.Shape({sceneFunc:function(a){var b,c;for(a.beginPath(),b=0;b<arrowCommands.length;b+=1)c=arrowCommands[b],"M"===c.type?a.moveTo(c.x,c.y):"L"===c.type?a.lineTo(c.x,c.y):"C"===c.type?a.bezierCurveTo(c.x1,c.y1,c.x2,c.y2,c.x,c.y):"Q"===c.type?a.quadraticCurveTo(c.x1,c.y1,c.x,c.y):"Z"===c.type&&a.closePath();a.fillStrokeShape(this)},fill:cfg.arrowColor});(function(){var a={}.hasOwnProperty,b=function(b,c){function d(){this.constructor=b}for(var e in c)a.call(c,e)&&(b[e]=c[e]);return d.prototype=c.prototype,b.prototype=new d,b.__super__=c.prototype,b};Grot.FieldWidget=function(a){function c(){c.__super__.constructor.apply(this,arguments),this.relativeScale=this.field.relativeScale,this.circle=new Kinetic.Circle({x:0,y:0,radius:cfg.circleRadius,fill:this.colors[this.field.value],transformsEnabled:"position"}),this.arrow=arrow.clone(),this.arrow.rotate(this.arrows[this.field.direction]),this.add(this.circle),this.add(this.arrow),this.scale(this.relativeScale)}return b(c,a),c.prototype.circle=null,c.prototype.label=null,c.prototype.field=null,c.prototype.callback=null,c.prototype.relativeScale=null,c.prototype.colors={gray:cfg.circleColor1,blue:cfg.circleColor2,green:cfg.circleColor3,red:cfg.circleColor4},c.prototype.arrows={left:270,right:90,up:0,down:180,none:0},c.prototype.relativeMove=function(a,b){return this.move({x:a-this.x(),y:b-this.y()})},c.prototype.reset=function(){var a;return this.circle.fill(this.colors[this.field.value]),a=this.arrows[this.field.direction]-this.arrow.rotation(),this.arrow.rotate(a)},c.prototype.setupCallback=function(a){var b;return this.callback=a,b=this,this.on("mousedown touchstart",function(a){return b.callback(b.field,a)})},c}(GrotEngine.Widget),Grot.Field=function(){function a(a,b,c){this.board=a,this.x=b,this.y=c,this.id=""+this.x+"-"+this.y,this.renderManager=this.board.renderManager,this.relativeScale=this.board.fieldRelativeScale,this.relativeRadius=2*cfg.circleRadius*this.relativeScale,this.resetRandoms(),this.widget=new Grot.FieldWidget({field:this})}return a.prototype.x=null,a.prototype.y=null,a.prototype.id=null,a.prototype.value=null,a.prototype.direction=null,a.prototype.widget=null,a.prototype.board=null,a.prototype.renderManager=null,a.prototype.relativeScale=null,a.prototype.points={gray:1,blue:2,green:3,red:4},a.prototype.resetRandoms=function(){var a;return a=["gray","gray","gray","gray","blue","blue","blue","green","green","red"],this.value=randomChoice(a),this.direction=randomChoice(["left","right","up","down"]),null!=this.widget?this.widget.reset():void 0},a.prototype.getPoints=function(){return this.points[this.value]},a.prototype.getFieldCenter=function(){var a,b;return b=2*cfg.circleRadius*this.relativeScale,a=b+cfg.spaceBetweenFields*this.renderManager.currentScale,[this.x*a+b,this.y*a+b]},a.prototype.updatePosition=function(a,b){return this.x=a,this.y=b,this.id=""+this.x+"-"+this.y},a}(),Grot.Board=function(a){function c(a){c.__super__.constructor.apply(this,arguments),this.background=new Kinetic.Rect({width:a.width,height:a.height,fill:cfg.bodyColor}),this.add(this.background),this.fieldRelativeScale=5/this.size,this.createBoard(this.size)}return b(c,a),c.prototype.size=9,c.prototype.fields=[],c.prototype.fieldRelativeScale=0,c.prototype.renderManager=null,c.prototype.createBoard=function(){var a,b,c,d,e;for(e=[],a=c=0,d=this.size-1;d>=0?d>=c:c>=d;a=d>=0?++c:--c)e.push(this.fields.push(function(){var c,d,e;for(e=[],b=c=0,d=this.size-1;d>=0?d>=c:c>=d;b=d>=0?++c:--c)e.push(new Grot.Field(this,a,b));return e}.call(this)));return e},c.prototype.getNextField=function(a,b){var c,d;if(null==b&&(b=null),c=b?b:a.direction,"left"===c){if(0===a.x)return[a,!0];d=this.fields[a.x-1][a.y]}else if("right"===c){if(a.x===this.size-1)return[a,!0];d=this.fields[a.x+1][a.y]}else if("up"===c){if(0===a.y)return[a,!0];d=this.fields[a.x][a.y-1]}else if("down"===c){if(a.y===this.size-1)return[a,!0];d=this.fields[a.x][a.y+1]}return"none"===d.direction?this.getNextField(d,c):[d,!1]},c.prototype.lowerField=function(a){var b,c,d,e,f,g,h;return f=a.x,g=a.y,h=this.getNextField(a,"down"),e=h[0],b=h[1],c=e.x,d=e.y,b||(d=e.y-1),d===g?[]:(this.fields[f][g]=this.fields[c][d],this.fields[f][g].updatePosition(f,g),this.fields[c][d]=a,this.fields[c][d].updatePosition(c,d),[c,d])},c}(GrotEngine.Layer)}).call(this),function(){var a=function(a,b){return function(){return a.apply(b,arguments)}},b={}.hasOwnProperty,c=function(a,c){function d(){this.constructor=a}for(var e in c)b.call(c,e)&&(a[e]=c[e]);return d.prototype=c.prototype,a.prototype=new d,a.__super__=c.prototype,a};Grot.MenuWidget=function(b){function d(){this.close=a(this.close,this),this.draw=a(this.draw,this);var b,c,e,f,g;d.__super__.constructor.apply(this,arguments),this.background=new Kinetic.Rect({width:600,height:900,x:0,y:0,fill:cfg.overlayColor,opacity:.9}),this.container=new GrotEngine.Widget({width:600,height:900,margins:{x:0,y:0},layer:this.menuLayer}),this.gameName=new Kinetic.Text({x:235,y:100,text:"GROT",align:"center",fontSize:60,fontFamily:cfg.fontFamily,fontStyle:cfg.fontStyle,fill:cfg.fontMenuColor}),this.line=new Kinetic.Rect({x:0,y:200,width:600,height:2,fill:cfg.fontMenuColor}),e=new Image,this.resetGameImg=new Kinetic.Image({x:125,y:300,image:e,width:75,height:75}),this.resetGameText=new Kinetic.Text({x:100,y:400,text:"New Game",align:"center",fontSize:25,fontFamily:cfg.fontFamily,fontStyle:cfg.fontStyle,fill:cfg.fontMenuColor}),g=new Image,this.scoreBoardLinkImg=new Kinetic.Image({x:410,y:300,image:g,width:75,height:75}),this.scoreBoardLinkText=new Kinetic.Text({x:385,y:400,text:"High scores",align:"center",fontSize:25,fontFamily:cfg.fontFamily,fontStyle:cfg.fontStyle,fill:cfg.fontMenuColor}),c=new Image,this.helpImage=new Kinetic.Image({x:125,y:550,image:c,width:75,height:75}),this.helpText=new Kinetic.Text({x:134,y:650,text:"Help",align:"center",fontSize:25,fontFamily:cfg.fontFamily,fontStyle:cfg.fontStyle,fill:cfg.fontMenuColor}),b=new Image,this.aboutImg=new Kinetic.Image({x:410,y:550,image:b,width:75,height:75}),this.aboutText=new Kinetic.Text({x:412,y:650,text:"About",align:"center",fontSize:25,fontFamily:cfg.fontFamily,fontStyle:cfg.fontStyle,fill:cfg.fontMenuColor}),f=new Image,this.resumeImg=new Kinetic.Image({x:265,y:740,image:f,width:75,height:75}),this.resumeText=new Kinetic.Text({x:258,y:820,text:"Resume",align:"center",fontSize:25,fontFamily:cfg.fontFamily,fontStyle:cfg.fontStyle,fill:cfg.fontMenuColor}),e.src="img/menu-new-game-icon.png",g.src="img/menu-high-score-icon.png",c.src="img/menu-help-icon.png",b.src="img/menu-about-icon.png",f.src="img/menu-resume-icon.png",this.resetGameImg.on("mousedown touchstart",function(){return function(){return window.location.replace(window.location.href)}}(this)),this.resetGameText.on("mousedown touchstart",function(){return function(){return window.location.replace(window.location.href)}}(this)),this.scoreBoardLinkImg.on("mousedown touchstart",function(){return function(){return window.location.replace(cfg.scoreBoardLink)}}(this)),this.scoreBoardLinkText.on("mousedown touchstart",function(){return function(){return window.location.replace(cfg.scoreBoardLink)}}(this)),this.helpImage.on("mousedown touchstart",function(a){return function(){return a.fire("menuRemove"),a.menuLayer.fire("showHelp")}}(this)),this.helpText.on("mousedown touchstart",function(a){return function(){return a.fire("menuRemove"),a.menuLayer.fire("showHelp")}}(this)),this.aboutImg.on("mousedown touchstart",function(a){return function(){return a.fire("menuRemove"),a.menuLayer.fire("showAbout")}}(this)),this.aboutText.on("mousedown touchstart",function(a){return function(){return a.fire("menuRemove"),a.menuLayer.fire("showAbout")}}(this)),this.resumeImg.on("mousedown touchstart",this.close),this.resumeText.on("mousedown touchstart",this.close),this.on("menuDraw",this.draw),this.on("menuRemove",this.close),this.fire("update")}return c(d,b),d.prototype.group=null,d.prototype.menuLayer=null,d.prototype.game=null,d.prototype.updateHandler=function(){return this.menuLayer.parent?this.container.fire("update"):void 0},d.prototype.draw=function(){return this.add(this.background),this.add(this.container),this.container.add(this.gameName),this.container.add(this.line),this.container.add(this.resetGameImg),this.container.add(this.resetGameText),this.container.add(this.scoreBoardLinkImg),this.container.add(this.scoreBoardLinkText),this.container.add(this.helpImage),this.container.add(this.helpText),this.container.add(this.aboutImg),this.container.add(this.aboutText),this.container.add(this.resumeImg),this.container.add(this.resumeText),this.getLayer().draw()},d.prototype.close=function(){return this.removeChildren(),this.menuLayer.fire("closeMenuOverlay")},d}(GrotEngine.Widget),Grot.GameOverWidget=function(b){function d(){this.close=a(this.close,this),this.draw=a(this.draw,this);var b,c;d.__super__.constructor.apply(this,arguments),this.background=new Kinetic.Rect({width:600,height:900,x:0,y:0,fill:cfg.overlayColor,opacity:.9}),this.container=new GrotEngine.Widget({width:600,height:900,margins:{x:0,y:0},layer:this.menuLayer}),this.line=new Kinetic.Rect({x:0,y:200,width:600,height:2,fill:cfg.fontMenuColor}),this.gameOverMsg=new Kinetic.Text({x:320,y:125,text:"Game Over",align:"center",fontSize:60,fontFamily:cfg.fontFamily,fontStyle:cfg.fontStyle,fill:cfg.fontMenuColor}),this.yourScoreMsg=new Kinetic.Text({x:315,y:300,text:"Your Score:",align:"center",fontSize:40,fontFamily:cfg.fontFamily,fontStyle:cfg.fontStyle,fill:cfg.fontMenuColor}),this.scoreResult=new Kinetic.Text({x:300,y:350,text:"",align:"center",fontSize:35,fontfamily:cfg.fontFamily,fontStyle:cfg.fontStyle,fill:"#00BFFF"}),b=new Image,this.resetGameImg=new Kinetic.Image({x:135,y:500,image:b,width:75,height:75}),this.resetGameText=new Kinetic.Text({x:180,y:610,text:"New Game",align:"center",fontSize:25,fontFamily:cfg.fontFamily,fontStyle:cfg.fontStyle,fill:cfg.fontMenuColor}),c=new Image,this.scoreBoardLinkImg=new Kinetic.Image({x:410,y:500,image:c,width:75,height:75}),this.scoreBoardLinkText=new Kinetic.Text({x:455,y:610,text:"High scores",align:"center",fontSize:25,fontFamily:cfg.fontFamily,fontStyle:cfg.fontStyle,fill:cfg.fontMenuColor}),b.src="img/menu-new-game-icon.png",c.src="img/menu-high-score-icon.png",this.resetGameImg.on("mousedown touchstart",function(){return function(){return window.location.replace(window.location.href)}}(this)),this.resetGameText.on("mousedown touchstart",function(){return function(){return window.location.replace(window.location.href)}}(this)),this.scoreBoardLinkImg.on("mousedown touchstart",function(){return function(){return window.location.replace(cfg.scoreBoardLink)}}(this)),this.scoreBoardLinkText.on("mousedown touchstart",function(){return function(){return window.location.replace(cfg.scoreBoardLink)}}(this)),this.centerElement(this.gameOverMsg),this.centerElement(this.yourScoreMsg),this.centerElement(this.resetGameText),this.centerElement(this.scoreBoardLinkText),this.on("gameOverDraw",this.draw),this.on("gameOverRemove",this.close)}return c(d,b),d.prototype.game=null,d.prototype.menuLayer=null,d.prototype.updateHandler=function(){return this.menuLayer.parent?this.container.fire("update"):void 0},d.prototype.draw=function(a){return this.scoreResult.setText(a),this.centerElement(this.scoreResult),this.add(this.background),this.add(this.container),this.container.add(this.gameOverMsg),this.container.add(this.line),this.container.add(this.yourScoreMsg),this.container.add(this.scoreResult),this.container.add(this.resetGameImg),this.container.add(this.resetGameText),this.container.add(this.scoreBoardLinkImg),this.container.add(this.scoreBoardLinkText),this.getLayer().draw()},d.prototype.close=function(){return this.removeChildren(),this.menuLayer.fire("closeMenuOverlay")},d}(GrotEngine.Widget),Grot.HelpWidget=function(b){function d(){this.close=a(this.close,this),this.draw=a(this.draw,this);var b;d.__super__.constructor.apply(this,arguments),this.background=new Kinetic.Rect({width:600,height:900,x:0,y:0,fill:cfg.overlayColor,opacity:.9}),this.container=new GrotEngine.Widget({width:600,height:900,margins:{x:0,y:0},layer:this.menuLayer}),this.appName=new Kinetic.Text({x:10,y:50,fontSize:60,fontFamily:cfg.fontFamily,text:"GROT",fill:cfg.fontMenuColor}),this.engAppName=this.appName.clone({y:110,x:10,fontSize:36,text:"(eng. Arrowhead)"}),this.description=this.appName.clone({y:180,x:10,width:580,fontSize:26,text:cfg.helpDesc}),this.points=this.appName.clone({y:550,x:25,fontSize:30,text:"Points:"}),this.pointsVisualisation=new GrotEngine.Widget({width:580,height:42,x:10,y:600}),this.circle1=new Kinetic.Circle({x:50,y:50,radius:40,fill:cfg.circleColor1}),this.circlePoints1=new Kinetic.Text({x:100,y:35,text:"x1",fill:cfg.fontMenuColor,fontSize:30,fontFamily:cfg.fontFamily}),this.circle2=this.circle1.clone({x:190,fill:cfg.circleColor2}),this.circlePoints2=this.circlePoints1.clone({x:240,text:"x2"}),this.circle3=this.circle1.clone({x:330,fill:cfg.circleColor3}),this.circlePoints3=this.circlePoints1.clone({x:380,text:"x3"}),this.circle4=this.circle1.clone({x:470,fill:cfg.circleColor4}),this.circlePoints4=this.circlePoints1.clone({x:520,text:"x4"}),b=new Image,this.resumeImg=new Kinetic.Image({x:265,y:740,image:b,width:75,height:75}),this.resumeText=new Kinetic.Text({x:258,y:820,text:"Resume",align:"center",fontSize:25,fontFamily:cfg.fontFamily,fontStyle:cfg.fontStyle,fill:cfg.fontMenuColor}),b.src="img/menu-resume-icon.png",this.resumeImg.on("mousedown touchstart",this.close),this.resumeText.on("mousedown touchstart",this.close),this.on("helpDraw",this.draw),this.on("helpRemove",this.close),this.fire("update")}return c(d,b),d.prototype.game=null,d.prototype.menuLayer=null,d.prototype.updateHandler=function(){return this.menuLayer.parent?this.container.fire("update"):void 0},d.prototype.draw=function(){return this.add(this.background),this.add(this.container),this.container.add(this.appName),this.container.add(this.engAppName),this.container.add(this.description),this.container.add(this.points),this.container.add(this.pointsVisualisation),this.pointsVisualisation.add(this.circle1),this.pointsVisualisation.add(this.circlePoints1),this.pointsVisualisation.add(this.circle2),this.pointsVisualisation.add(this.circlePoints2),this.pointsVisualisation.add(this.circle3),this.pointsVisualisation.add(this.circlePoints3),this.pointsVisualisation.add(this.circle4),this.pointsVisualisation.add(this.circlePoints4),this.container.add(this.resumeImg),this.container.add(this.resumeText),this.getLayer().draw()},d.prototype.close=function(){return this.removeChildren(),this.menuLayer.fire("closeMenuOverlay")},d}(GrotEngine.Widget),Grot.AboutWidget=function(b){function d(){this.close=a(this.close,this),this.draw=a(this.draw,this);var b,c;d.__super__.constructor.apply(this,arguments),this.background=new Kinetic.Rect({width:600,height:900,x:0,y:0,fill:cfg.overlayColor,opacity:.9}),this.container=new GrotEngine.Widget({width:600,height:900,margins:{x:0,y:0},layer:this.menuLayer}),this.appName=new Kinetic.Text({x:10,y:50,fontSize:60,fontFamily:cfg.fontFamily,text:"GROT",fill:cfg.fontMenuColor}),this.appVer=this.appName.clone({y:110,x:10,fontSize:36,text:cfg.aboutVer}),this.description=this.appName.clone({y:180,x:10,width:580,fontSize:26,text:cfg.aboutDesc}),b=new Image,this.logoImg=new Kinetic.Image({x:15,y:245,image:b,width:182,height:182}),c=new Image,this.resumeImg=new Kinetic.Image({x:265,y:740,image:c,width:75,height:75}),this.resumeText=new Kinetic.Text({x:258,y:820,text:"Resume",align:"center",fontSize:25,fontFamily:cfg.fontFamily,fontStyle:cfg.fontStyle,fill:cfg.fontMenuColor}),b.src="img/stxnext-logo.png",c.src="img/menu-resume-icon.png",this.logoImg.on("mousedown touchstart",function(){return function(){return window.location.replace(cfg.stxnextLink)}}(this)),this.resumeImg.on("mousedown touchstart",this.close),this.resumeText.on("mousedown touchstart",this.close),this.on("aboutDraw",this.draw),this.on("aboutRemove",this.close),this.fire("update")}return c(d,b),d.prototype.game=null,d.prototype.menuLayer=null,d.prototype.updateHandler=function(){return this.menuLayer.parent?this.container.fire("update"):void 0},d.prototype.draw=function(){return this.add(this.background),this.add(this.container),this.container.add(this.appName),this.container.add(this.appVer),this.container.add(this.description),this.container.add(this.logoImg),this.container.add(this.resumeImg),this.container.add(this.resumeText),this.getLayer().draw()},d.prototype.close=function(){return this.removeChildren(),this.menuLayer.fire("closeMenuOverlay")},d}(GrotEngine.Widget),Grot.MenuOverlay=function(a){function b(){b.__super__.constructor.apply(this,arguments),this.gameOverWidget=new Grot.GameOverWidget({menuLayer:this}),this.menuWidget=new Grot.MenuWidget({menuLayer:this}),this.helpWidget=new Grot.HelpWidget({menuLayer:this}),this.aboutWidget=new Grot.AboutWidget({menuLayer:this}),this.on("showGameOver",this.gameOverWidgetDraw),this.on("showMenu",this.menuWidgetDraw),this.on("showHelp",this.helpWidgetDraw),this.on("showAbout",this.aboutWidgetDraw),this.on("closeMenuOverlay",this.closeMenuOverlay),this.on("onOverlayOpen",this.onOverlayOpen)}return c(b,a),b.prototype.renderManager=null,b.prototype.closeMenuOverlay=function(){return this.renderManager.stage.fire("normalizeBoardStuff"),document.body.style.backgroundColor=cfg.bodyColor,this.removeChildren,this.draw()},b.prototype.onOverlayOpen=function(){return this.renderManager.stage.fire("blurBoardStuff"),document.body.style.backgroundColor=cfg.overlayBodyColor},b.prototype.updateHandler=function(){return b.__super__.updateHandler.apply(this,arguments),this.gameOverWidget.fire("update"),this.menuWidget.fire("update"),this.helpWidget.fire("update"),this.aboutWidget.fire("update")},b.prototype.gameOverWidgetDraw=function(a){return this.fire("onOverlayOpen"),this.add(this.gameOverWidget),this.gameOverWidget.fire("gameOverDraw",a)},b.prototype.menuWidgetDraw=function(){return this.fire("onOverlayOpen"),this.add(this.menuWidget),this.menuWidget.fire("menuDraw")},b.prototype.helpWidgetDraw=function(){return this.fire("onOverlayOpen"),this.add(this.helpWidget),this.helpWidget.fire("helpDraw")},b.prototype.aboutWidgetDraw=function(){return this.fire("onOverlayOpen"),this.add(this.aboutWidget),this.aboutWidget.fire("aboutDraw")},b}(GrotEngine.Layer)}.call(this),function(){var a,b,c,d,e=function(a,b){return function(){return a.apply(b,arguments)}},f={}.hasOwnProperty,g=function(a,b){function c(){this.constructor=a}for(var d in b)f.call(b,d)&&(a[d]=b[d]);return c.prototype=b.prototype,a.prototype=new c,a.__super__=b.prototype,a};window.TWEEN_DURATION=cfg.tweenDuration,window.delay1s=function(a){return setTimeout(a,1e3)},window.randomChoice=function(a){return a[Math.floor(Math.random()*a.length)]},b=function(){function a(a){var b,c,d,e;this.queryString=a,this.queryString||(this.queryString=null!=(e=window.document.location.search)?e.substr(1):void 0),this.variables=this.queryString.split("&"),this.pairs=function(){var a,e,f,g,h;for(f=this.variables,h=[],a=0,e=f.length;e>a;a++)c=f[a],h.push((g=c.split("="),b=g[0],d=g[1],g));return h}.call(this)}return a.prototype.get=function(a){var b,c,d,e,f,g;
for(f=this.pairs,d=0,e=f.length;e>d;d++)if(g=f[d],b=g[0],c=g[1],b===a)return c},a}(),c=function(a){function b(a,c){var d,f,g,h,i,j,k;for(this.boardSize=a,this.game=c,this.startMove=e(this.startMove,this),k=this.getWindowSize(),h=k[0],d=k[1],this.currentScale=this.calculateScaleUnit(),this.addLayers(),this.addWidgets(),this.stage=new Kinetic.Stage({container:"wrap",width:h,height:d-4}),this.stage.on("onStageUpdated",this.onStageUpdated.bind(this)),this.stage.on("blurBoardStuff",this.blurBoardStuff.bind(this)),this.stage.on("normalizeBoardStuff",this.normalizeBoardStuff.bind(this)),this.stage.fire("onStageUpdated"),this.stage.add(this.board),this.stage.add(this.barsLayer),this.stage.add(this.animLayer),this.stage.add(this.menuOverlay),this.barsLayer.filters([Kinetic.Filters.Blur]),this.board.filters([Kinetic.Filters.Blur]),b.__super__.constructor.apply(this,arguments),g=this.stage.getLayers(),i=0,j=g.length;j>i;i++)f=g[i],f.fire("update")}return g(b,a),b.prototype.board=null,b.prototype.stage=null,b.prototype.barsLayer=null,b.prototype.animLayer=null,b.prototype.game=null,b.prototype.topBarWidget=null,b.prototype.menuOverlay=null,b.prototype.addLayers=function(){return this.barsLayer=new GrotEngine.Layer({width:600,height:900,margins:{x:0,y:0},renderManager:this}),this.board=new Grot.Board({size:this.boardSize,renderManager:this,margins:{x:0,y:180},width:600,height:600}),this.game.board=this.board,this.animLayer=new GrotEngine.Layer({hitGraphEnabled:!1,margins:{x:0,y:180},width:600,height:600,renderManager:this}),this.menuOverlay=new Grot.MenuOverlay({width:600,height:900,margins:{x:0,y:0},renderManager:this})},b.prototype.addWidgets=function(){var a,b,c,d,e,f;for(this.topBarWidget=new Grot.TopBarWidget({game:this.game}),this.bottomBarWidget=new Grot.BottomBarWidget({game:this.game}),a=c=0,e=this.board.size-1;e>=0?e>=c:c>=e;a=e>=0?++c:--c)for(b=d=0,f=this.board.size-1;f>=0?f>=d:d>=f;b=f>=0?++d:--d)this.board.add(this.board.fields[a][b].widget);return this.barsLayer.add(this.topBarWidget),this.barsLayer.add(this.bottomBarWidget)},b.prototype.normalizeBoardStuff=function(){return this.barsLayer.blurRadius(0),this.board.blurRadius(0),this.board.clearCache(),this.barsLayer.clearCache(),this.barsLayer.batchDraw(),this.board.batchDraw()},b.prototype.blurBoardStuff=function(){return this.barsLayer.cache(),this.board.cache(),this.barsLayer.blurRadius(10),this.board.blurRadius(10),this.barsLayer.batchDraw(),this.board.batchDraw()},b.prototype.moveFieldToLayer=function(a,b){var c;return c=a.widget.getLayer(),a.widget.moveTo(b),c.draw(),b.draw()},b.prototype.onStageUpdated=function(){var a,b,c,d,e,f,g,h,i,j,k;for(e=g=0,i=this.board.size-1;i>=0?i>=g:g>=i;e=i>=0?++g:--g)for(f=h=0,j=this.board.size-1;j>=0?j>=h:h>=j;f=j>=0?++h:--h)c=this.board.fields[e][f],k=c.getFieldCenter(),a=k[0],b=k[1],d=c.widget,d.relativeMove(a,b),null==d.callback&&d.setupCallback(this.startMove)},b.prototype.listening=function(a){var b,c,d,e,f,g;for(b=d=0,f=this.board.size-1;f>=0?f>=d:d>=f;b=f>=0?++d:--d)for(c=e=0,g=this.board.size-1;g>=0?g>=e:e>=g;c=g>=0?++e:--e)this.board.fields[b][c].widget.listening(a);return this.board.drawHit()},b.prototype.startMove=function(a){return this.listening(!1),this.game.moves-=1,this.game.scoreDiff=0,this.game.movesDiff=0,this.topBarWidget.update(),this.movePoints=0,this.moveLength=0,this.moveToNextField(a)},b.prototype.moveToNextField=function(a){var b,c,d,e,f,g,h;return g=this.board.getNextField(a),e=g[0],d=g[1],h=e.getFieldCenter(),b=h[0],c=h[1],a.direction="none",this.movePoints+=a.getPoints(),this.moveLength+=1,this.moveFieldToLayer(a,this.animLayer),f=new Kinetic.Tween({node:a.widget,duration:TWEEN_DURATION,x:b,y:c,opacity:0,onFinish:function(a){return function(){return d?a.checkEmptyLines():a.moveToNextField(e),this.destroy()}}(this)}),f.play()},b.prototype.checkEmptyLines=function(){var a,b,c,d,e,f,g,h,i,j,k,l;for(c=e=0,i=this.board.size-1;i>=0?i>=e:e>=i;c=i>=0?++e:--e){for(a=!0,d=f=0,j=this.board.size-1;j>=0?j>=f:f>=j;d=j>=0?++f:--f)"none"!==this.board.fields[c][d].direction&&(a=!1);a&&(this.movePoints+=10*this.board.size)}for(d=g=0,k=this.board.size-1;k>=0?k>=g:g>=k;d=k>=0?++g:--g){for(b=!0,c=h=0,l=this.board.size-1;l>=0?l>=h:h>=l;c=l>=0?++h:--h)"none"!==this.board.fields[c][d].direction&&(b=!1);b&&(this.movePoints+=10*this.board.size)}return this.lowerFields()},b.prototype.lowerFields=function(){var a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r;for(h=[],j=k=o=this.board.size-2;0>=o?0>=k:k>=0;j=0>=o?++k:--k)for(i=l=0,p=this.board.size-1;p>=0?p>=l:l>=p;i=p>=0?++l:--l)c=this.board.fields[i][j],"none"!==c.direction&&(f=this.board.lowerField(c),2===f.length&&(d=f[0],e=f[1],q=c.getFieldCenter(),a=q[0],b=q[1],this.moveFieldToLayer(c,this.animLayer),h.push(new Kinetic.Tween({node:c.widget,easing:Kinetic.Easings.BounceEaseOut,duration:TWEEN_DURATION,x:a,y:b,onFinish:function(){return function(){return this.destroy()}}(this)}))));if(h.length>0){for(h[0].onFinish=function(a){return function(){return a.fillEmptyFields(),this.destroy()}}(this),r=[],m=0,n=h.length;n>m;m++)g=h[m],r.push(g.play());return r}return this.fillEmptyFields()},b.prototype.fillEmptyFields=function(){var a,b,c,d,e,f,g,h,i,j,k,l;for(c=[],d=f=0,j=this.board.size-1;j>=0?j>=f:f>=j;d=j>=0?++f:--f)for(e=g=0,k=this.board.size-1;k>=0?k>=g:g>=k;e=k>=0?++g:--g)a=this.board.fields[d][e],"none"===a.direction&&(a.resetRandoms(),this.moveFieldToLayer(a,this.animLayer),c.push(new Kinetic.Tween({node:a.widget,opacity:1,duration:TWEEN_DURATION,onFinish:function(){return function(){return this.destroy()}}(this)})));if(this.stage.fire("onStageUpdated"),c.length>0){for(c[0].onFinish=function(a){return function(){return a.finishMove(),this.destroy()}}(this),l=[],h=0,i=c.length;i>h;h++)b=c[h],l.push(b.play());return l}return this.finishMove()},b.prototype.gameOver=function(){return this.menuOverlay.fire("showGameOver",this.game.score)},b.prototype.finishMove=function(){var a,b,c,d,e,f;for(this.game.score+=this.movePoints,this.game.scoreDiff=this.movePoints,d=Math.floor(this.game.score/(5*this.board.size*this.board.size))+this.board.size-1,this.moveLength>=d&&(this.game.movesDiff=this.moveLength-d,this.game.moves+=this.game.movesDiff),this.topBarWidget.update(),c=function(){var b,c,d,e;for(d=this.animLayer.children,e=[],b=0,c=d.length;c>b;b++)a=d[b],e.push(a.field);return e}.call(this),e=0,f=c.length;f>e;e++)b=c[e],this.moveFieldToLayer(b,this.board);return this.game.moves>0?this.listening(!0):this.gameOver(this.game)},b}(GrotEngine.RenderManager),a=function(a){function d(){var a,e;d.__super__.constructor.apply(this,arguments),e=parseInt((new b).get("size")),a=cfg.customBoardSize&&e?e:cfg.defaultBoardSize,this.renderManager=new c(a,this)}return g(d,a),d.prototype.board=null,d.prototype.score=0,d.prototype.scoreDiff=0,d.prototype.moves=5,d.prototype.movesDiff=0,d.prototype.renderManager=null,d}(GrotEngine.Game),document.body.style.cssText="background-color: "+cfg.bodyColor+"; margin: 0; padding: 0;",window.game=d=new a}.call(this);